// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum TradeStatus {
  OFFER_MADE
  AWAITING_FEE
  LOCKED
  CONFIRMED_BY_BUYER
  CONFIRMED_BY_SELLER
  COMPLETED
  DISPUTED
  CANCELLED
  DISPUTE_RESOLVED
}

enum ListingStatus {
  ACTIVE
  TRADED
  ARCHIVED
  RESERVED
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
  REVOKED
}

enum BountyStatus {
  OPEN
  CLAIMED
  SUBMITTED
  COMPLETED
}

enum GovernanceStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
}

enum ExchangeMode {
  VP
  CASH
  HYBRID
}


model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String
  fullName        String?
  role            Role     @default(USER)
  globalTrustScore Float   @default(1.0) // Base trust multiplier
  walletBalance   Int      @default(0)   // Value Points (VP)
  isSupporter     Boolean  @default(false) // Donations (Badge only)

  country         String   @default("Lebanon")
  subscriptionTier String  @default("FREE") // FREE, BUSINESS, PREMIUM
  
  // Ambassador Program
  referredByUserId String?
  ambassadorScore  Int     @default(0)
  ambassadorStatus String  @default("NONE") // NONE, PENDING, ACTIVE, REJECTED

  // Business Profile
  isBusiness               Boolean @default(false)
  businessName             String? // Trading name if different from full name
  businessVerificationStatus VerificationStatus @default(NONE)
  businessVerificationData String? // JSON: { country, notes, documentsChecked, adminId }

  // Community Service Profile (Gardeners, Teachers, etc.)
  communityRole            String? // DOCTOR, TEACHER, GARDENER, STUDENT, VETERAN, FIREFIGHTER
  communityVerificationStatus VerificationStatus @default(NONE)
  
  // "Shy Gardener Protocol": Photo with tree is encouraged but OPTIONAL. 
  // Standard ID or simple work proof is sufficient if user is shy.
  communityEvidence        String? // JSON: { idPhotoUrl, certUrl, optionalTreeSelfieUrl }
  
  // v1.2: Multi-Tier Verification & Compliance
  verificationLevel        Int      @default(1) // 1: Community, 2: Professional, 3: Institutional
  complianceMetadata       String?  // JSON: Encrypted compliance history
  
  // Content Moderation
  reportCount     Int      @default(0)
  isBanned        Boolean  @default(false)
  banReason       String?
  bannedAt        DateTime?
  banExpiresAt    DateTime? // Null = Permanent if isBanned=true
  moderationStrikes Int    @default(0)
  
  // ADS: Shadowban Protocol
  isShadowbanned  Boolean  @default(false)
  shadowbanReason String?

  // Terms of Service Acceptance
  termsAcceptedAt DateTime?

  // üõ°Ô∏è Cybersecurity Protocol Stack: Layer I & II
  refreshTokenHash  String?   // Hashed for rotation safety
  mfaSecret         String?   // Encrypted TOTP secret
  mfaEnabled        Boolean   @default(false)
  lastIp            String?   // Behavioral profiling
  riskScore         Int       @default(0) // 0-100 dynamic risk assessment
  termsVersion    String?  // e.g., "1.0", tracks which version user agreed to

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  conversations    Conversation[] @relation("UserConversations")

  // Social Auth
  authProvider     String?  // GOOGLE, FACEBOOK, OUTLOOK, INSTAGRAM
  avatarUrl        String?
  bannerUrl        String?  // Custom profile background
  themePreferences String?  // JSON: { font: "Inter", cardColor: "#ffffff", textColor: "#000000" }

  // Phone Verification
  phoneNumber     String?  @unique
  phoneVerified   Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listings        Listing[]
  buyerTrades     Trade[]   @relation("BuyerTrades")
  sellerTrades    Trade[]   @relation("SellerTrades")
  categoryTrusts  UserCategoryTrust[]
  sentTransactions     Transaction[] @relation("Sender")
  receivedTransactions Transaction[] @relation("Receiver")
  receivedGrants       CommunityGrant[]
  bounties        Bounty[]
  organizedEvents CommunityEvent[]
  moderationFlags ContentModerationFlag[]
  successors      Successor[]
  contributions   Contribution[]
  achievements    UserAchievement[]
  geoDropClaims   GeoDropClaim[]

  // Universal Succession & Continuity Protocol
  heir1Name       String?
  heir1Key        String? // Secret fingerprint
  heir2Name       String?
  heir2Key        String?
  heir3Name       String?
  heir3Key        String?
  heir4Name       String?
  heir4Key        String?
  heir5Name       String?
  heir5Key        String?

  lastActivity    DateTime @default(now())
  isDeceased      Boolean  @default(false)
  deathDate       String?
  deathPlace      String?
  mokhtarName      String?
  mokhtarLicense   String?
  activityMetric   UserActivityMetric?
  businessLicense  BusinessLicense?

  governanceRequests GovernanceRequest[] @relation("GovernanceRequester")
  governanceApprovals GovernanceRequest[] @relation("GovernanceApprover")

  subscriptions     Subscription[]
  tradeReviewsGiven TradeReview[]    @relation("Reviewer")
  tradeReviews      TradeReview[]    @relation("Reviewee")
  fraudReports      FraudReport[]    @relation("Reporter")
  fraudRecords      FraudReport[]    @relation("Accused")

  @@index([email])
  @@index([role])
  @@index([isBusiness])
}

model Category {
  id              String   @id @default(uuid())
  name            String   @unique // e.g., "Vehicles", "Food"
  description     String?
  
  // Category-Based Value Control
  minVP           Int      @default(0)
  maxVP           Int      @default(1000)
  trustThreshold  Float    @default(0.8) // Min trust required to list
  isLocked        Boolean  @default(false) // Admin freeze

  // Phase 4.1: Legally Defensible Operational Escrow
  escrowPercentage Float   @default(15.0) // Max percentage for this category
  maxModerationVP  Int     @default(50)   // Max per bucket
  maxVerificationVP Int    @default(50)
  maxDisputeVP     Int     @default(100)
  maxLogisticsVP   Int     @default(100)
  maxFraudVP       Int     @default(200)

  listings        Listing[]
  userTrusts      UserCategoryTrust[]
  trades          Trade[]
  marketSnapshots MarketSnapshot[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UserCategoryTrust {
  id              String   @id @default(uuid())
  userId          String
  categoryId      String
  trustScore      Float    @default(1.0) // Category-specific trust multiplier

  user            User     @relation(fields: [userId], references: [id])
  category        Category @relation(fields: [categoryId], references: [id])

  @@unique([userId, categoryId])
}

model Listing {
  id              String   @id @default(uuid())
  title           String
  description     String
  priceVP         Int
  originalPrice   Int?     // Market price in Value Points
  condition       String?  // NEW, LIKE_NEW, USED_GOOD, USED_FAIR, POOR
  originType      String   @default("PERSONAL_GIFT") // PERSONAL_GIFT, HANDMADE, etc.
  authenticityStatus String @default("UNVERIFIED") // VERIFIED_ORIGINAL, REPLICA_DECLARED, UNVERIFIED
  isRefurbished   Boolean  @default(false)
  images          String // Stored as JSON string locally
  location        String   @default("Beirut") // Item Location
  country         String   @default("Lebanon") // Worldwide accessibility

  // Hybrid Pricing
  priceCash       Float?
  priceCurrency   String?  @default("USD") // USD or LBP
  
  // JSON field for category-specific attributes (e.g. proof of ownership, production date)
  attributes      String? // Was Json, stored as string in SQLite
  
  // v1.2: Listing enhancements
  listingType     String   @default("OFFER") // OFFER (normal) or REQUEST (reverse listing)
  expiresAt       DateTime? // Optional expiration for time-limited listings
  
  // Content Moderation
  isActive        Boolean  @default(true)
  moderationStatus ModerationStatus  @default(APPROVED)
  
  status          ListingStatus   @default(ACTIVE)
  
  categoryId      String
  sellerId        String
  
  category        Category @relation(fields: [categoryId], references: [id])
  seller          User     @relation(fields: [sellerId], references: [id])
  trades          Trade[]
  moderationFlags ContentModerationFlag[]
  messages        Message[]
  
  // Community Events
  communityEventId String?
  communityEvent   CommunityEvent? @relation("EventListings", fields: [communityEventId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([location])
  @@index([listingType])
  @@index([createdAt])
}

model Trade {
  id              String      @id @default(uuid())
  listingId       String
  buyerId         String
  sellerId        String
  categoryId      String

  offerVP         Int
  status          TradeStatus      @default(OFFER_MADE)
  
  // Phase 4: Dynamic Operational Escrow (Coordination & Verification)
  coordinationEscrowVP Int     @default(0)   // Calculated at creation
  operationalEscrowVP  Int     @default(0)   // For operational costs like verification/logistics
  isVerified      Boolean     @default(false)
  justification   String?     // Overall verification note

  // Feature: Cash Sweetener (Top-Up)
  cashOffer       Float?      // Optional cash amount
  cashCurrency    String?     @default("USD") // USD, LBP, EUR

  // Brokerage & Hybrid Marketplace
  exchangeMode    ExchangeMode @default(VP)
  platformFeeSeller Float      @default(0)
  platformFeeBuyer  Float      @default(0)
  isRealityChecked  Boolean    @default(false)


  
  // v1.2: Trade enhancements
  intentTimestamp DateTime?   // Soft commitment timestamp (non-binding)
  preTradeChecklist String?   // JSON: {timeAgreed, locationAgreed, conditionAgreed}
  
  buyerConfirmed  Boolean     @default(false)
  sellerConfirmed Boolean     @default(false)

  expiresAt       DateTime?   // Auto-refund if not confirmed by this time

  listing         Listing  @relation(fields: [listingId], references: [id])
  buyer           User     @relation("BuyerTrades", fields: [buyerId], references: [id])
  seller          User     @relation("SellerTrades", fields: [sellerId], references: [id])
  category        Category @relation(fields: [categoryId], references: [id])
  
  timeline        TradeTimeline[]
  operationCosts  TradeOperationCost[]
  transactions    Transaction[]
  conversations   Conversation[]
  reviews         TradeReview[]
  fraudReports    FraudReport[]
  messages        Message[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([status])
}

model CommunityEvent {
  id          String   @id @default(uuid())
  title       String
  description String
  location    String
  imageUrl    String?
  startDate   DateTime
  endDate     DateTime
  
  status      EventStatus @default(UPCOMING)

  organizerId String
  organizer   User     @relation(fields: [organizerId], references: [id])
  
  eventListings Listing[] @relation("EventListings")
  geoDrops      GeoDrop[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum EventStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

// Immutable record of cost allocations
model TradeOperationCost {
  id              String   @id @default(uuid())
  tradeId         String
  bucket          String   // MODERATION, VERIFICATION, DISPUTE, LOGISTICS, FRAUD
  amountVP        Int
  justification   String
  adminId         String
  timestamp       DateTime @default(now())

  trade           Trade    @relation(fields: [tradeId], references: [id])
}

// APPEND-ONLY LEDGER
model Transaction {
  id              String   @id @default(uuid())
  tradeId         String
  fromUserId      String?  // Null for system minting
  toUserId        String?  // Null for system burn
  amountVP        Int
  
  type            String   // TRANSFER, OPERATIONAL_ESCROW, PENALTY, REWARD, ESCROW_REFUND
  timestamp       DateTime @default(now())

  trade           Trade    @relation(fields: [tradeId], references: [id])
  fromUser        User?    @relation("Sender", fields: [fromUserId], references: [id])
  toUser          User?    @relation("Receiver", fields: [toUserId], references: [id])
}

model SystemConfig {
  id        Int      @id @default(1)
  isFrozen  Boolean  @default(false) // Global Kill Switch
  
  alphaCode       String   @default("2abwal2ibin")
  betaCode        String   @default("love one another")
  fingerprintCode String   @default("FINGERPRINT")

  // Phase 4: Dynamic Operational Escrow (Coordination)
  baseEscrowRate   Int      @default(15)
  laborBaseline    Int      @default(6)

  // Community Emergency Support Protocol
  emergencyFundVP Int      @default(0)
  ambassadorFundVP Int     @default(0) // 1% of Trade Value
  adminFundVP      Int     @default(0) // 10% of Trade Value

  // AI Market Pulse & Crisis Awareness
  marketSentimentIndex Float   @default(0.7) // 0.0 (Crash) - 1.0 (Boom)
  isCrisisActive       Boolean @default(true) // Default to true for Lebanon context
  lastMarketCheck      DateTime @default(now())
  
  // v1.2: Feature Flags for safe rollout
  featureFlags    String?  // JSON: {timeline, activityIndicators, reverseListings, etc.}
  
  // Succession & Continuity
  heir1           String   @default("Siham Hareb")
  heir1Key        String   @default("be")
  heir2           String   @default("Sandra Azzi Alkorem")
  heir2Key        String   @default("happy")
  heir3           String   @default("Lara Azzi")
  heir3Key        String   @default("i")
  heir4           String   @default("Joseph Chidiac")
  heir4Key        String   @default("love")
  heir5           String   @default("Alexander Chidiac")
  heir5Key        String   @default("you")
  
  // Advanced Death Verification Protocol
  lastAdminActivity DateTime @default(now())
  deathCertificateVerified Boolean @default(false)
  deathDate       String?
  deathPlace      String?
  mokhtarName     String?
  mokhtarLicense  String?

  // Institutional Payments
  whishPhoneNumber String   @default("0096171023083")
  omtPhoneNumber   String?
  
  // Dynamic Limits & Legal
  ambassadorTradeThreshold Int @default(100) // Adjustable via Admin Panel
  legalEntityId    String?  // For Agricultural/NGO Registration
  
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id              String   @id @default(uuid())
  adminId         String?  // Optional if system action
  userId          String?  // The user who triggered the event (if applicable)
  action          String   // e.g., "FREEZE_SYSTEM", "GRANT_VP", "BAN_USER"
  details         String   // JSON string details
  ipAddress       String?
  userAgent       String?
  
  // Phase II: Integrity & Risk
  riskScore       Int?     // Risk Score at time of event (0-100)
  hash            String?  // SHA-256 integrity hash of this record
  previousHash    String?  // Hash of the previous record (Blockchain-style linking)
  
  createdAt       DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
}

model Message {
  id              String   @id @default(uuid())
  content         String
  senderId        String
  receiverId      String
  conversationId  String
  isRead          Boolean  @default(false)
  
  // Context Fields for Smart Chat
  tradeId         String?
  listingId       String?
  templateKey     String?  @default("CUSTOM")
  
  createdAt       DateTime @default(now())

  sender          User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver        User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  trade           Trade?   @relation(fields: [tradeId], references: [id])
  listing         Listing? @relation(fields: [listingId], references: [id])
}

model Conversation {
  id              String   @id @default(uuid())
  tradeId         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  participants    User[]   @relation("UserConversations")
  messages        Message[]
  trade           Trade?   @relation(fields: [tradeId], references: [id])
}

model CommunityGrant {
  id              String   @id @default(uuid())
  recipientId     String
  amountVP        Int
  reason          String
  adminId         String?
  
  recipient       User     @relation(fields: [recipientId], references: [id])
  
  createdAt       DateTime @default(now())
}

model ContentModerationFlag {

  id              String   @id @default(uuid())
  listingId       String?  // Optional: might be flagged during upload before listing exists
  reportedByUserId String?
  
  reason          String   // Matched prohibited keyword or user report reason
  category        String   // DRUGS, WEAPONS, STOLEN, COUNTERFEIT, PRIVACY_VIOLATION
  severity        String   // AUTO_REJECT, HIGH_RISK, MEDIUM_RISK, LOW_RISK
  matchedKeywords String?  // JSON array of keywords that triggered flag
  evidenceUrl     String?  // URL of the flagged content (e.g. image with phone number)
  
  status          ModerationStatus   @default(PENDING)
  reviewedBy      String?
  reviewNotes     String?
  reviewedAt      DateTime?
  
  listing         Listing?  @relation(fields: [listingId], references: [id])
  reportedBy      User?    @relation(fields: [reportedByUserId], references: [id])
  
  createdAt       DateTime @default(now())
}

// ========================================
// v1.2 NON-MONETARY FEATURES
// ========================================

// 1. Trade Timeline - Immutable state progression tracking
model TradeTimeline {
  id              String   @id @default(uuid())
  tradeId         String
  state           String   // OFFER_SENT, OFFER_ACCEPTED, ITEMS_LOCKED, MEETUP_AGREED, TRADE_COMPLETED, TRADE_VERIFIED
  timestamp       DateTime @default(now())
  metadata        String?  // JSON for additional context
  
  trade           Trade    @relation(fields: [tradeId], references: [id])
  
  @@index([tradeId])
}



// 2. User Activity Metrics - Passive trust signals
model UserActivityMetric {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  lastSeenAt      DateTime @default(now())
  averageReplyHours Float? // Calculated from last 20 interactions
  calculatedAt    DateTime @default(now())
  
  // Gamification: Streaks
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastLoginDate   DateTime @default(now()) // Used to calc streaks (Daily)
  
  updatedAt       DateTime @updatedAt
}

// 5. City Pulse - Cached city-level statistics
model CityPulseCache {
  id              String   @id @default(uuid())
  city            String
  country         String
  topCategories   String   // JSON array of {categoryId, name, count}
  newListingsToday Int     @default(0)
  activeTraders   Int      @default(0)
  
  // Phase 5: Market Sentiment
  sentimentScore   Int      @default(50) // 0-100
  isCrisisActive   Boolean  @default(false)

  lastUpdated     DateTime @default(now())
  
  @@unique([city, country], name: "city_country")
  @@index([country])
}

// 7. Community Bounties - "Builders' Hub"
model Bounty {
  id              String   @id @default(uuid())
  title           String
  description     String
  rewardVP        Int
  status          BountyStatus   @default(OPEN)
  
  assigneeId      String?
  assignee        User?    @relation(fields: [assigneeId], references: [id])
  
  submissionEvidence String? // Link to PR or Doc
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Successor {
  id              String   @id @default(uuid())
  fullName        String   // e.g. Gia Alkoroum
  dateOfBirth     DateTime 
  parentId        String
  
  parent          User     @relation(fields: [parentId], references: [id])
  
  // Locking Mechanism
  unlockDate      DateTime // DOB + 21 Years
  isUnlocked      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// MeetPorter ‚Äî Intelligence & Analytics Engine
model SearchLog {
  id           String   @id @default(uuid())
  queryHash    String   // sha256 of normalized query
  sessionHash  String?  // sha256 of session identifier
  intentVector String?  // Stringified intent classification
  locationHash String?  // sha256 of zone_id/region
  country      String?
  createdAt    DateTime @default(now())

  @@index([queryHash])
  @@index([locationHash])
}

model InteractionLog {
  id           String   @id @default(uuid())
  sessionHash  String?  // sha256 of session
  type         String   // VIEW_LISTING, CLICK_CATEGORY, VISIT_PROFILE, BOOKMARK
  targetId     String   // ID of the listing, profile, or category
  intensity    Int      @default(1)
  intentVector String?  // Stringified intent tags
  createdAt    DateTime @default(now())

  @@index([type])
  @@index([targetId])
}

model MarketSnapshot {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  supplyCount     Int      // Active listings
  demandScore     Float    // Based on search/interaction logs
  opportunityIndex Float   // Scarcity indicator
  tradeVelocity   Float    // Completion rate
  
  
  @@unique([date, categoryId])
}

// üèõÔ∏è Phase 8: Institutional Business Verification & Licensing
model BusinessLicense {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])
  
  registrationNumber String  // Commercial Register / Tax ID
  permitType        String   // e.g. "Physical Goods", "Logistics", "Food/Health"
  issuingAuthority  String   // e.g. "Ministry of Industry"
  evidence          String   // JSON: { links: string[], photos: string[] }
  
  status            VerificationStatus   @default(PENDING)
  issuedAt          DateTime
  expiresAt         DateTime
  lastVerifiedAt    DateTime @default(now())
  adminNotes        String?  // Internal institutional audit notes
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// üèõÔ∏è Phase 9: Governance Security (Dual Control)
model GovernanceRequest {
  id              String   @id @default(uuid())
  requesterId     String   // Admin who initiated the action
  actionType      String   // e.g., "FREEZE_SYSTEM", "WIPE_VAULT", "GRANT_ADMIN"
  payload         String   // JSON: Arguments for the action
  
  status          GovernanceStatus   @default(PENDING)
  
  approverId      String?  // Admin who approved (must be != requesterId)
  approvalNote    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  executedAt      DateTime?

  requester       User     @relation("GovernanceRequester", fields: [requesterId], references: [id])
  approver        User?    @relation("GovernanceApprover", fields: [approverId], references: [id])

  @@index([status])
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  tier            String   // BUSINESS, INSTITUTIONAL
  status          ModerationStatus @default(PENDING) // Reusing status enum for simplicity
  amount          Float
  currency        String
  transactionId   String?  // Whish/OMT reference
  receiptUrl      String?  
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model TradeReview {
  id              String   @id @default(uuid())
  tradeId         String
  trade           Trade    @relation(fields: [tradeId], references: [id])
  reviewerId      String
  reviewer        User     @relation("Reviewer", fields: [reviewerId], references: [id])
  revieweeId      String
  reviewee        User     @relation("Reviewee", fields: [revieweeId], references: [id])
  rating          Int
  comment         String?
  createdAt       DateTime @default(now())

  @@index([tradeId])
  @@index([revieweeId])
}

model FraudReport {
  id              String   @id @default(uuid())
  tradeId         String
  trade           Trade    @relation(fields: [tradeId], references: [id])
  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id])
  accusedId       String
  accused         User     @relation("Accused", fields: [accusedId], references: [id])
  reason          String
  evidence        String?  // Links or photo URLs
  status          ModerationStatus @default(PENDING)
  adminNotes      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tradeId])
  @@index([status])
}

// Phase 11: Community Economics - Voluntary Contributions
model Contribution {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  tradeId         String?  // Optional: track which trade prompted this
  amount          Float
  currency        String   @default("USD")
  message         String?  // Optional supporter message
  isPublic        Boolean  @default(false)
  paymentProof    String?
  status          String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  createdAt       DateTime @default(now())
  
  @@index([userId])
}

model OtpCode {
  id        String   @id @default(uuid())
  phoneNumber String @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ========================================
// v1.3 GAMIFICATION & GROWTH PROTOCOL
// ========================================

model Achievement {
  id          String   @id @default(uuid())
  title       String
  description String
  rewardVP    Int
  iconUrl     String?
  criteria    String?  // JSON: {type: "TRADE_COUNT", threshold: 1}
  
  userAchievements UserAchievement[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
}

model GeoDrop {
  id          String   @id @default(uuid())
  name        String
  description String?
  location    String   // Lat/Long or Address
  rewardVP    Int
  
  qrCodeHash  String   // Secret payload in QR
  maxClaims   Int      @default(100)
  currentClaims Int    @default(0)
  
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  
  // Link to Events (e.g. "Farmers Market Drop")
  communityEventId String?
  communityEvent   CommunityEvent? @relation(fields: [communityEventId], references: [id])
  
  claims      GeoDropClaim[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GeoDropClaim {
  id          String   @id @default(uuid())
  userId      String
  geoDropId   String
  claimedAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  geoDrop     GeoDrop  @relation(fields: [geoDropId], references: [id])

  @@unique([userId, geoDropId])
  @@index([userId])
}
